<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Building Fault Tolerant KV Storage System - Part 1 | Learning Loop</title><meta name=keywords content="#Replication,#Leader-Election"><meta name=description content="This blog post is part of a series detailing my implementation of a fault-tolerant key-value server using the RAFT consensus protocol.
Before diving into RAFT and its mechanics, it&rsquo;s crucial to grasp the concept of a replicated state machine and its significance in building systems that are both fault-tolerant and highly available.
Replicated State Machine
A replicated state machine is essentially a collection of identical machines working together. One machine acts as the &ldquo;master,&rdquo; handling client requests and dictating the system&rsquo;s operations. The other machines, the &ldquo;replicas,&rdquo; diligently copy the master&rsquo;s state. This &ldquo;state&rdquo; encompasses all the data necessary for the system to function correctly, remembering the effects of previous operations. Think of a key-value store: the state would be the key-value pairs themselves, replicated across all machines to maintain consistency and resilience.
Having the master&rsquo;s state copied across multiple machines enables us to use these replicas in several ways. They can take over as the new master if the original fails, or handle read operations to reduce the load on the master. Because the state is copied across machines, network issues like latency, packet loss, and packet reordering significantly affect how closely a replica&rsquo;s state matches the master&rsquo;s. The difference between the master&rsquo;s (most up-to-date) state and a replica&rsquo;s state is known as replication lag. Generally, we aim to minimize this lag, and different systems offer varying levels of consistency (which we will discuss later when covering replication in RAFT)."><meta name=author content><link rel=canonical href=https://harshrai654.github.io/blogs/building-fault-tolerant-kv-storage-system---part-1/><link crossorigin=anonymous href=/blogs/assets/css/stylesheet.4a2d4f6ce40ed4a68aae2b504ff6913b1f64bf1b352beea0c885d29c6d987670.css integrity="sha256-Si1PbOQO1KaKritQT/aROx9kvxs1K+6gyIXSnG2YdnA=" rel="preload stylesheet" as=style><link rel=icon href=https://harshrai654.github.io/blogs/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://harshrai654.github.io/blogs/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://harshrai654.github.io/blogs/favicon-32x32.png><link rel=apple-touch-icon href=https://harshrai654.github.io/blogs/apple-touch-icon.png><link rel=mask-icon href=https://harshrai654.github.io/blogs/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://harshrai654.github.io/blogs/building-fault-tolerant-kv-storage-system---part-1/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script data-goatcounter=https://ttharsh.goatcounter.com/count async src=//gc.zgo.at/count.js></script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://harshrai654.github.io/blogs/ accesskey=h title="Learning Loop (Alt + H)">Learning Loop</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://harshrai654.github.io/blogs/>Home</a></div><h1 class="post-title entry-hint-parent">Building Fault Tolerant KV Storage System - Part 1</h1><div class=post-meta><span title='2025-10-03 20:38:34 +0530 +0530'>October 3, 2025</span>&nbsp;·&nbsp;23 min</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#replicated-state-machine aria-label="Replicated State Machine">Replicated State Machine</a></li><li><a href=#raft---a-consensus-algorithm aria-label="RAFT - A Consensus Algorithm">RAFT - A Consensus Algorithm</a><ul><li><a href=#logs-state-lifecycle-and-rpcs aria-label="Logs, State Lifecycle and RPCs">Logs, State Lifecycle and RPCs</a></li><li><a href=#rules-of-election aria-label="Rules Of Election">Rules Of Election</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>This blog post is part of a series detailing my implementation of a fault-tolerant key-value server using the RAFT consensus protocol.
Before diving into RAFT and its mechanics, it&rsquo;s crucial to grasp the concept of a replicated state machine and its significance in building systems that are both fault-tolerant and highly available.</p><h2 id=replicated-state-machine>Replicated State Machine<a hidden class=anchor aria-hidden=true href=#replicated-state-machine>#</a></h2><p>A replicated state machine is essentially a collection of identical machines working together. One machine acts as the &ldquo;master,&rdquo; handling client requests and dictating the system&rsquo;s operations. The other machines, the &ldquo;replicas,&rdquo; diligently copy the master&rsquo;s <em>state</em>. This &ldquo;state&rdquo; encompasses all the data necessary for the system to function correctly, remembering the effects of previous operations. Think of a key-value store: the <em>state</em> would be the key-value pairs themselves, replicated across all machines to maintain consistency and resilience.
Having the master&rsquo;s state copied across multiple machines enables us to use these replicas in several ways. They can take over as the new master if the original fails, or handle read operations to reduce the load on the master. Because the state is copied across machines, network issues like latency, packet loss, and packet reordering significantly affect how closely a replica&rsquo;s state matches the master&rsquo;s. The difference between the master&rsquo;s (most up-to-date) state and a replica&rsquo;s state is known as replication lag. Generally, we aim to minimize this lag, and different systems offer varying levels of consistency (which we will discuss later when covering replication in RAFT).</p><blockquote><p>Aside from application-level replication, which primarily requires context of the state needed for replication or enforces a set of rules for the state that can be replicated, another approach involves replicating the entire machine state at the instruction level. This includes replicating instruction outputs and interrupt behaviour.  This method ensures that machines execute the same set and order of instructions and maintain identical memory pages, resulting in an exact replica of the entire machine. However, this approach is more challenging to control, as managing interrupts, I/O, and replicating them to other machines is complex. An example of such an approach is discussed in <a href=https://pdos.csail.mit.edu/6.824/papers/vm-ft.pdf>The Design of a Practical System for Fault-Tolerant Virtual Machines</a>_. This paper details the approach they followed when designing a hypervisor to capture and replicate the state of guest machines.</p></blockquote><h2 id=raft---a-consensus-algorithm>RAFT - A Consensus Algorithm<a hidden class=anchor aria-hidden=true href=#raft---a-consensus-algorithm>#</a></h2><p><img alt="Pasted image 20251001155927.png" loading=lazy src=/blogs/media/pasted-image-20251001155927.png>
RAFT is a consensus algorithm for managing a replicated log. Consensus algorithms allow a collection of machines to work as a group that can survive failures of some of its members. A replicated state is generally maintained as a replicated log. Each server maintains its own copy of logs, and keeping the replicated log consistent is the job of the consensus algorithm.</p><p>Let&rsquo;s take an example of an operation done on a key-value store.
A client sends a command like <code>PUT x=2</code>, which is received by the master server of the group. The consensus module of the server receives this command and appends it to its log.
The master&rsquo;s consensus module communicates with other servers about this new log and ensures that each server&rsquo;s log contains the same command in the same order.
Once commands are replicated, each server processes the command on its own state machine, and since the log is the same on each server, the final state on each server results in the same output. As a result, the servers appear to form a single, highly reliable state machine.</p><p>RAFT implements this consensus between all servers by electing a leader and giving it the responsibility to decide the sequence of log operation that will be appended and propagated to each member. Flow of logs only happen in one direction from leader to other servers so if a particular server&rsquo;s sequence does not match to leader&rsquo;s sequence of logs, leader can instruct the follower (replica) server to erase its log and strictly follow leader itself.</p><blockquote><p><strong>From the RAFT paper:</strong>
Given the leader approach, Raft decomposes the consensus problem into three relatively independent subproblems, which are discussed in the subsections that follow:</p><ul><li>Leader election: a new leader must be chosen when an existing leader fails.</li><li>Log replication: the leader must accept log entries from clients and replicate them across the cluster, forcing the other logs to agree with its own.</li><li>Safety: if any server has applied a particular log entry to its state machine, then no other server may apply a different command for the same log index.</li></ul></blockquote><h3 id=logs-state-lifecycle-and-rpcs>Logs, State Lifecycle and RPCs<a hidden class=anchor aria-hidden=true href=#logs-state-lifecycle-and-rpcs>#</a></h3><p>Each <code>LogEntry</code> consists of the command it contains and the term value.
<img alt="Pasted image 20251003142917.png" loading=lazy src=/blogs/media/pasted-image-20251003142917.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln>1</span><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>LogEntry</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>	</span><span class=nx>Command</span><span class=w> </span><span class=kd>interface</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>	</span><span class=nx>Term</span><span class=w>    </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Raft divides time into terms of arbitrary length. <code>Terms</code> are numbered with consecutive integers. Each term begins with an election, in which one or more candidates attempt to become leader.</p><p>Each server has a role, with only one designated as the Leader for a specific period. The remaining servers are either Followers, who heed the Leader&rsquo;s communications, or Candidates. Candidates solicit votes from other servers if they haven&rsquo;t received communication from a Leader within a set timeframe.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln>1</span><span class=cl><span class=kd>const</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>	</span><span class=nx>StateFollower</span><span class=w> </span><span class=nx>ServerState</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>iota</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>	</span><span class=nx>StateLeader</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>	</span><span class=nx>StateCandidate</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>Due to variations in timing, different servers might see the changes between terms at different moments. A server might also miss an election or even entire terms. <em>In Raft, terms serve as a logical clock, enabling servers to identify outdated information like old leaders.</em> Every server keeps track of a current term number, which consistently increases. Servers exchange current terms during communication; if one server has a smaller term than another, it updates to the larger term. <em>Should a candidate or leader find its term is outdated, it immediately becomes a follower.</em> <em>A server will reject any request that includes an old term number.</em></p><p>The diagram below illustrates how a server&rsquo;s role changes under different circumstances.
<img alt="Pasted image 20251002154539.png" loading=lazy src=/blogs/media/pasted-image-20251002154539.png>
To grasp the role of elections and how <code>Term</code> serves as a time marker in RAFT, we must first understand</p><ul><li>How the threshold time is determined, after which a follower can become a candidate and start an election.</li><li>How each server of the cluster communicates with one another</li></ul><p>Imagine a cluster of three servers experiencing a network partition, where server 0, the current leader, cannot communicate with servers 1 and 2. If the servers have a fixed timeout value for election, multiple servers might initiate elections simultaneously, resulting in no majority each time, with each server only receiving its own vote. Consequently, the cluster cannot decide on a leader for the next term. With each re-election, a server&rsquo;s term value (also known as <code>currentTerm</code>) increases by 1. So, when the previous server 0, from, say, term 1, rejoins the cluster after recovery, it will vote for either server 1 or 2, as both are requesting votes for their own <code>currentTerm</code> value, which will now be N if N elections have occurred after server 0 went down, with each server starting its own election and failing to become leader due to the lack of a majority. Even if server 0 votes for one server and a majority is achieved, the new leader needs to communicate with all peers, and if that doesn&rsquo;t happen quickly, we&rsquo;ll see another election. Overall, the cluster will be unstable and unable to progress due to election instability.</p><p>To resolve this, we introduce a small element of randomness to each server&rsquo;s election timeout. This minimizes the chance of multiple servers starting elections simultaneously and maximizes the likelihood of a single server triggering a re-election and continuing as leader for subsequent terms.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln> 1</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>Make</span><span class=p>(</span><span class=nx>peers</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>labrpc</span><span class=p>.</span><span class=nx>ClientEnd</span><span class=p>,</span><span class=w> </span><span class=nx>me</span><span class=w> </span><span class=kt>int</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>	</span><span class=nx>persister</span><span class=w> </span><span class=o>*</span><span class=nx>tester</span><span class=p>.</span><span class=nx>Persister</span><span class=p>,</span><span class=w> </span><span class=nx>applyCh</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=nx>raftapi</span><span class=p>.</span><span class=nx>ApplyMsg</span><span class=p>)</span><span class=w> </span><span class=nx>raftapi</span><span class=p>.</span><span class=nx>Raft</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>	</span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>	</span><span class=c1>// other state initialisation, we will see them later</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>	</span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>	
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>	</span><span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimeout</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=mi>1500</span><span class=o>+</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Int63</span><span class=p>()</span><span class=o>%</span><span class=mi>1500</span><span class=p>))</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>	</span><span class=k>go</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nf>ticker</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>	</span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>	</span><span class=c1>// other state initialisation, we will see them later</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>	</span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>	
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>	
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>rf</span><span class=w> </span><span class=o>*</span><span class=nx>Raft</span><span class=p>)</span><span class=w> </span><span class=nf>ticker</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=p>!</span><span class=nx>rf</span><span class=p>.</span><span class=nf>killed</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>		</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>StateLeader</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>lastContactFromLeader</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimeout</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>			</span><span class=k>go</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nf>startElection</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>		</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>		</span><span class=c1>// pause for a random amount of time between 50 and 350</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>		</span><span class=c1>// milliseconds.</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>		</span><span class=nx>heartbeatMS</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>50</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Int63</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>300</span><span class=p>)</span><span class=w> </span><span class=c1>// [50, 350)ms time range</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>		</span><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>heartbeatMS</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Each RAFT server&rsquo;s state (We will discuss each state in detail later on):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln> 1</span><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Raft</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>	</span><span class=nx>mu</span><span class=w>        </span><span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span><span class=w>          </span><span class=c1>// Lock to protect shared access to this peer&#39;s state</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>	</span><span class=nx>peers</span><span class=w>     </span><span class=p>[]</span><span class=o>*</span><span class=nx>labrpc</span><span class=p>.</span><span class=nx>ClientEnd</span><span class=w> </span><span class=c1>// RPC end points of all peers</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>	</span><span class=nx>persister</span><span class=w> </span><span class=o>*</span><span class=nx>tester</span><span class=p>.</span><span class=nx>Persister</span><span class=w>   </span><span class=c1>// Object to hold this peer&#39;s persisted state</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>	</span><span class=nx>me</span><span class=w>        </span><span class=kt>int</span><span class=w>                 </span><span class=c1>// this peer&#39;s index into peers[]</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>	</span><span class=nx>dead</span><span class=w>      </span><span class=kt>int32</span><span class=w>               </span><span class=c1>// set by Kill()</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>	</span><span class=c1>// Persisted State</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>	</span><span class=nx>currentTerm</span><span class=w>          </span><span class=kt>int</span><span class=w>        </span><span class=c1>// latest term server has seen</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>	</span><span class=nx>votedFor</span><span class=w>             </span><span class=kt>int</span><span class=w>        </span><span class=c1>// candidateId that received vote in current term</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>	</span><span class=nx>log</span><span class=w>                  </span><span class=p>[]</span><span class=nx>LogEntry</span><span class=w> </span><span class=c1>// log entries; each entry contains command for state machine, and term when entry was received by leader</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>	</span><span class=nx>snapshotLastLogIndex</span><span class=w> </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>	</span><span class=nx>snapshotLastLogTerm</span><span class=w>  </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>	</span><span class=c1>// snapshot             []byte</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>	</span><span class=c1>// Volatile state</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>	</span><span class=nx>commitIndex</span><span class=w>           </span><span class=kt>int</span><span class=w>                   </span><span class=c1>// index of highest log entry known to be committed</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>	</span><span class=nx>lastApplied</span><span class=w>           </span><span class=kt>int</span><span class=w>                   </span><span class=c1>// index of highest log entry applied to state machine</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>	</span><span class=nx>state</span><span class=w>                 </span><span class=nx>ServerState</span><span class=w>           </span><span class=c1>// role of this server</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>	</span><span class=nx>lastContactFromLeader</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w>             </span><span class=c1>// Last timestamp at which leader sent heartbeat to current server</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>	</span><span class=nx>electionTimeout</span><span class=w>       </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w>         </span><span class=c1>// time duration since last recieved heartbeat after which election will be trigerred by this server</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>	</span><span class=nx>applyCh</span><span class=w>               </span><span class=kd>chan</span><span class=w> </span><span class=nx>raftapi</span><span class=p>.</span><span class=nx>ApplyMsg</span><span class=w> </span><span class=c1>// Channel where a raft server sends it commands to be applied to state machine</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>	</span><span class=c1>// Volatile leader state</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>	</span><span class=nx>nextIndex</span><span class=w>  </span><span class=p>[]</span><span class=kt>int</span><span class=w>      </span><span class=c1>//	for each server, index of the next log entry to send to that server</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>	</span><span class=nx>matchIndex</span><span class=w> </span><span class=p>[]</span><span class=kt>int</span><span class=w>      </span><span class=c1>//	for each server, index of highest log entry known to be replicated on server</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>	</span><span class=nx>applyCond</span><span class=w>  </span><span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span><span class=w> </span><span class=c1>// Condition validable to signal applier channel to send commands to apply channel</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>	</span><span class=nx>leaderCancelFunc</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>CancelFunc</span><span class=w> </span><span class=c1>// Go context for a leader, called when we need to cancel leader&#39;s context and leader is stepping down</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>	</span><span class=nx>replicatorCond</span><span class=w>   </span><span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span><span class=w>         </span><span class=c1>// Leader&#39;s conditon variable to signal replicator threads for each peer to either send heartbeat or new logs to each peer</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>For the communication between servers, RAFT consensus algorithm uses RPC for</p><ul><li>Requesting vote from other peers - <code>RequestVote</code> RPC</li><li>Propagate changes to log entries from leader to followers - <code>AppendEntries</code> RPC</li><li>Sending heartbeats from leader to follower - <code>AppendEntries</code> RPC with empty log data
<em><strong>RPC, or Remote Procedure Call</strong></em>, is a programming paradigm that allows a program to execute a procedure (function, method) on a different machine as if it were a local procedure call.  Essentially, it&rsquo;s a way to build distributed systems where one program (the client) can request a service from another program (the server) over a network.
Go provides <code>net/rpc</code> package which abstract most of the work related to serialization of RPC arguments and deserialization at receiving end and the underlying network call with provided data, to know more check Go&rsquo;s <a href=https://pkg.go.dev/net/rpc><code>net/rpc</code> package</a></li></ul><p>RPC arguments and reply structs as also shown in the original paper <a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf>(page 4, fig 2)</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln> 1</span><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>RequestVoteArgs</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>	</span><span class=nx>Term</span><span class=w>         </span><span class=kt>int</span><span class=w> </span><span class=c1>// candidate’s term</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>	</span><span class=nx>CandidateId</span><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=c1>// candidate requesting vote</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>	</span><span class=nx>LastLogIndex</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=c1>// index of candidate’s last log entry</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>	</span><span class=nx>LastLogTerm</span><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=c1>// term of candidate’s last log entry</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>RequestVoteReply</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>	</span><span class=nx>Term</span><span class=w>        </span><span class=kt>int</span><span class=w>  </span><span class=cp>//currentTerm, for candidate to update itself in case someone else is leader now</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>	</span><span class=nx>VoteGranted</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=c1>// true means candidate received vote</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1>// Invoked by leader to replicate log entries; also used as heartbeat.</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>AppendEntriesArgs</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>	</span><span class=nx>Term</span><span class=w>         </span><span class=kt>int</span><span class=w>        </span><span class=c1>// leader’s term</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>	</span><span class=nx>LeaderId</span><span class=w>     </span><span class=kt>int</span><span class=w>        </span><span class=c1>// so follower can redirect clients</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>	</span><span class=nx>PrevLogIndex</span><span class=w> </span><span class=kt>int</span><span class=w>        </span><span class=c1>// index of log entry immediately preceding new ones</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>	</span><span class=nx>PrevLogTerm</span><span class=w>  </span><span class=kt>int</span><span class=w>        </span><span class=c1>// term of prevLogIndex entry</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>	</span><span class=nx>Entries</span><span class=w>      </span><span class=p>[]</span><span class=nx>LogEntry</span><span class=w> </span><span class=c1>// log entries to store (empty for heartbeat; may send more than one for efficiency)</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>	</span><span class=nx>LeaderCommit</span><span class=w> </span><span class=kt>int</span><span class=w>        </span><span class=c1>// leader’s commitIndex</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>AppendEntriesReply</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>	</span><span class=nx>Term</span><span class=w>          </span><span class=kt>int</span><span class=w>  </span><span class=c1>// currentTerm, for leader to update itself</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>	</span><span class=nx>Success</span><span class=w>       </span><span class=kt>bool</span><span class=w> </span><span class=c1>// true if follower contained entry matching prevLogIndex and prevLogTerm</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>	</span><span class=nx>ConflictIndex</span><span class=w> </span><span class=kt>int</span><span class=w>  </span><span class=c1>// Followers index which is conflicting with leader&#39;s prevLogIndex</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>	</span><span class=nx>ConflictTerm</span><span class=w>  </span><span class=kt>int</span><span class=w>  </span><span class=c1>// Followers term of conflicting log</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>InstallSnapshotArgs</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>	</span><span class=nx>Term</span><span class=w>              </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>	</span><span class=nx>LeaderId</span><span class=w>          </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>	</span><span class=nx>LastIncludedIndex</span><span class=w> </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>	</span><span class=nx>LastIncludedTerm</span><span class=w>  </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>	</span><span class=nx>Data</span><span class=w>              </span><span class=p>[]</span><span class=kt>byte</span><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=rules-of-election>Rules Of Election<a hidden class=anchor aria-hidden=true href=#rules-of-election>#</a></h3><p>As we have already seen, an election timeout triggers an election by a given server, which is a <code>Follower</code>. This timeout occurs when the <code>Follower</code> does not receive any <code>AppendEntries</code> RPCs (even empty ones, containing no log) from the leader. When an election is initiated with <code>rf.startElection()</code>, the follower increments its <code>currentTerm</code> by 1 and issues <code>RequestVote</code> RPCs to each of its peers in parallel, awaiting their responses. At this point, three outcomes are possible:</p><ul><li>The Follower gains a majority and becomes the leader.
In this case, the Follower converts to the Leader state, and <code>setupLeader</code> method sets up <code>rf.replicate</code> go routine for each of the other peers in a separate go routine. These go routines are responsible for sending heartbeats and logs using <code>AppendEntries</code> RPC calls, We use condition variable <code>replicatorCond</code> to signal these waiting go threads either when new log entry comes up or when heartbeat timeout occurs.</li><li>While waiting for votes, a candidate may receive an <code>AppendEntries</code> RPC from another server claiming to be the leader. <em><strong>If the leader’s term (included in its RPC) is at least as large as the candidate’s current term, then the candidate recognizes the leader as legitimate and of newer term hence reverts to the follower state. If the term in the RPC is smaller than the candidate’s current term, the candidate rejects the RPC and remains in the candidate state.</strong></em></li><li>A candidate neither wins nor loses the election. If many followers become candidates simultaneously, votes could be split, preventing any single candidate from obtaining a majority. When this happens, each candidate will time out and start a new election by incrementing its term and initiating another round of <code>RequestVote</code> RPCs. <em>The randomness in the election timeout helps prevent split votes from happening indefinitely.</em></li></ul><p>According to the current rules, a server receiving a <code>RequestVote</code> RPC with a <code>Term</code> greater than its own should grant its vote. However, this could lead to an outdated server with an incomplete log becoming leader. Since the leader is responsible for log propagation and can overwrite follower logs, it&rsquo;s possible for such an outdated leader to erase already committed logs for which clients have received responses - an undesirable outcome.
Re-examining the <code>RequestVoteArgs</code> reveals that, in addition to <code>Term</code>, the struct includes <code>LastLogIndex</code> and <code>LastLogTerm</code>, representing the candidate&rsquo;s last log entry&rsquo;s index and term, respectively. These values help determine if the candidate&rsquo;s log contains at least the latest committed entries. The rules for verifying this when voting are straightforward:
Raft determines the more up-to-date of two logs by comparing the index and term of their last entries. If the last entries have different terms, the log with the latter term is considered more up-to-date. If the logs share the same last term, the longer log is deemed more up-to-date.</p><p>Let&rsquo;s understand how RAFT prevents a stale server from winning an election and becoming a leader with the help of an example:
consider a follower <strong>A</strong> that gets partitioned away from the rest of the cluster. Its election timeout fires, so it increments its term and starts an election by sending <code>RequestVote</code> RPCs. Since it cannot reach the majority, it doesn’t become leader.
Meanwhile, the rest of the cluster still has a leader <strong>B</strong>. Because <strong>B</strong> can talk to a majority of servers, it continues to accept new log entries, replicate them, and safely commit them. Remember: in Raft, an entry is considered <em>committed</em> only after it is stored on a majority of servers.
Later, when connectivity is restored, server <strong>A</strong> now has a higher term than <strong>B</strong>. This causes <strong>A</strong> to reject <code>AppendEntries</code> from <strong>B</strong>, forcing <strong>B</strong> to step down. At this moment, no leader exists until a new election is held.
Here’s where Raft’s rules keep the system safe:</p><ul><li><strong>A cannot win leadership election</strong> because its log is missing committed entries that the majority already agreed on. Other servers will refuse to vote for it by comparing their latest log index and term with <code>RequestVote</code> RPC Arg&rsquo;s <code>LastLogIndex</code> and <code>LastLogTerm</code>.</li><li>A new leader must have logs that are at least as up-to-date as the majority. This ensures that committed entries are never lost.</li><li>Once a new leader is elected, it brings <strong>A</strong> back in sync by replicating the missing committed entries.
This scenario highlights how Raft’s election rules preserve correctness: even if a partitioned follower returns with a higher term, it cannot override the majority’s progress. Leadership always ends up with a server that reflects all committed entries, and the cluster converges to the same state.
In upcoming parts, we’ll dive deeper into Raft’s log replication process and how <strong>heartbeats</strong> help keep leaders and followers synchronized.
Given below is the implementation for <code>RequestVote</code> which highlights all the restrictions and responses for various election restrictions.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln> 1</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>rf</span><span class=w> </span><span class=o>*</span><span class=nx>Raft</span><span class=p>)</span><span class=w> </span><span class=nf>RequestVote</span><span class=p>(</span><span class=nx>args</span><span class=w> </span><span class=o>*</span><span class=nx>RequestVoteArgs</span><span class=p>,</span><span class=w> </span><span class=nx>reply</span><span class=w> </span><span class=o>*</span><span class=nx>RequestVoteReply</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>	</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Peer: %d | RequestVote]: Candidate %d seeking vote for term: %d.\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>CandidateId</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>	</span><span class=c1>// Election voting restrictions for follower</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>	</span><span class=c1>// - Candidate&#39;s term is older than follower from whom it is seeking vote</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>	</span><span class=c1>// - Follower already voted</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>	</span><span class=c1>// - Candidate&#39;s log is older then the follower</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>	</span><span class=c1>// In all the above cases follower will not vote for the candidate and respond back with its current term</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>	</span><span class=c1>// for the candidate to roll back to follower</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>	</span><span class=nx>isCandidateOfOlderTerm</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>isCandidateOfOlderTerm</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>		</span><span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>		</span><span class=nx>reply</span><span class=p>.</span><span class=nx>VoteGranted</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>		</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Peer: %d | RequestVote]: Candidate %d is of older term. Candidate&#39;s term: %d | My current term %d\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>CandidateId</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>		</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Peer: %d | RequestVote]: Candidate %d is of newer or equal term. Candidate&#39;s term: %d | My current term %d\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>CandidateId</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>StateLeader</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>				</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Peer: %d | RequestVote]: Recieved vote request from candiate of higher term, winding up my own leadership setup.\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>				</span><span class=k>if</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>leaderCancelFunc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>					</span><span class=nx>rf</span><span class=p>.</span><span class=nf>leaderCancelFunc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>					</span><span class=nx>rf</span><span class=p>.</span><span class=nx>replicatorCond</span><span class=p>.</span><span class=nf>Broadcast</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>			</span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>			</span><span class=nx>rf</span><span class=p>.</span><span class=nx>state</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>StateFollower</span><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>			</span><span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w>			</span><span class=nx>rf</span><span class=p>.</span><span class=nf>persist</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=w>		</span><span class=nx>canVote</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>CandidateId</span><span class=w>
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=w>		</span><span class=kd>var</span><span class=w> </span><span class=nx>currentLatestLogTerm</span><span class=w> </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=ln>43</span><span class=cl><span class=w>		</span><span class=nx>currentLatestLogIndex</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>log</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>44</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>45</span><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>currentLatestLogIndex</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>46</span><span class=cl><span class=w>			</span><span class=nx>currentLatestLogTerm</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>log</span><span class=p>[</span><span class=nx>currentLatestLogIndex</span><span class=p>].</span><span class=nx>Term</span><span class=w>
</span></span></span><span class=line><span class=ln>47</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>snapshotLastLogIndex</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>48</span><span class=cl><span class=w>			</span><span class=nx>currentLatestLogTerm</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>snapshotLastLogTerm</span><span class=w>
</span></span></span><span class=line><span class=ln>49</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>50</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>51</span><span class=cl><span class=w>		</span><span class=nx>currentLatestLogIndex</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>snapshotLastLogIndex</span><span class=w>
</span></span></span><span class=line><span class=ln>52</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>53</span><span class=cl><span class=w>		</span><span class=nx>isCandidateLogOlder</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>LastLogTerm</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>currentLatestLogTerm</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>LastLogTerm</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>currentLatestLogTerm</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>LastLogIndex</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>currentLatestLogIndex</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>54</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>55</span><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>canVote</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>!</span><span class=nx>isCandidateLogOlder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>56</span><span class=cl><span class=w>			</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Peer: %d | RequestVote]: Granted vote for term: %d, To candidate %d.\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>CandidateId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>57</span><span class=cl><span class=w>			</span><span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>CandidateId</span><span class=w>
</span></span></span><span class=line><span class=ln>58</span><span class=cl><span class=w>			</span><span class=nx>rf</span><span class=p>.</span><span class=nx>lastContactFromLeader</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>59</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>60</span><span class=cl><span class=w>			</span><span class=nx>reply</span><span class=p>.</span><span class=nx>VoteGranted</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=ln>61</span><span class=cl><span class=w>			</span><span class=nx>rf</span><span class=p>.</span><span class=nf>persist</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>62</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>63</span><span class=cl><span class=w>			</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Peer: %d | RequestVote]: Candidate %d log is older than mine. Log(index/term): Candidate&#39;s: (%d, %d) | Mine: (%d, %d).\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>CandidateId</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>LastLogIndex</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>LastLogTerm</span><span class=p>,</span><span class=w> </span><span class=nx>currentLatestLogIndex</span><span class=p>,</span><span class=w> </span><span class=nx>currentLatestLogTerm</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>64</span><span class=cl><span class=w>			</span><span class=nx>reply</span><span class=p>.</span><span class=nx>VoteGranted</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=ln>65</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>66</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>67</span><span class=cl><span class=w>		</span><span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w>
</span></span></span><span class=line><span class=ln>68</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>69</span><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Here are some things to keep in mind when implementing the <code>RequestVote</code> RPC:</p><ul><li>Note the use of <code>snapshotLastLogIndex</code> and <code>snapshotLastLogTerm</code>, which relate to log compaction. Think of a snapshot as capturing the current state machine&rsquo;s image, allowing us to shorten logs up to that point, reducing overall log size. We&rsquo;ll explore how this works and its benefits later. For now, understand that a server, when verifying if a candidate has current logs, needs to read its own. If the log is truncated shortly after a snapshot, we store the snapshot&rsquo;s last details, like the index and term of the log at that index. Snapshotting generally shortens the log, but because indexes always increase, we use <code>snapshotLastLogIndex</code> as an offset to get the right index.</li><li>When a candidate gets a majority, it calls <code>setupLeader</code>, creating a context that can be cancelled, using Go&rsquo;s context package. This context returns a function, <code>leaderCancelFunc</code>, which, when called, cancels the context. We do this when a leader steps down, such as when it receives a <code>RequestVote</code> RPC from a candidate with a higher term. In this case, we cancel the leader&rsquo;s context. This is useful when the leader is performing async operations (like sending heartbeats or logs) and waiting for them. We then wait for the operation to complete or the context to be cancelled, signalling that we no longer need to wait because the current server is no longer the leader. We&rsquo;ll see what happens when a leader&rsquo;s context is cancelled later.</li><li>A potentially confusing aspect is that when we receive a <code>RequestVote</code> RPC response denying the vote and containing a <strong>Term greater than our current one</strong>, we examine the candidate&rsquo;s current state. This state might no longer be &ldquo;candidate&rdquo; because the <code>RequestVote</code> RPC could be delayed, and the node might have already gained a majority and become the leader. Despite any RPC delays, we strictly adhere to a core Raft principle: <em>upon receiving an RPC response with a Term greater than our current Term, we immediately update our Term to match the response. If we are the leader, we step down.</em> This rule is crucial because the <strong>Term serves as a time indicator for the entire Raft cluster. Discovering that time has progressed requires us to adapt accordingly.</strong></li></ul><p>So to summarize:
When a follower receives a <code>RequestVote</code>, it rejects the request if:</p><ol><li>The candidate’s term is smaller (<code>args.Term &lt; rf.currentTerm</code>).</li><li>It has already voted for another candidate in this term (<code>rf.votedFor != -1 && rf.votedFor != args.CandidateId</code>).</li><li>The candidate’s log is less up-to-date than its own, according to Raft’s freshness rule:
Candidate’s last log term must be greater, or equal with a log index at least as large.</li></ol><p>We have already seen how <code>ticker</code> calls <code>startElection</code> method based on election timeout, Let&rsquo;s now understand with given below implementation of <code>startElection</code>, How a candidate asks for votes and what are the edge cases to consider while waiting for <code>RequestVote</code> RPC responses</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=ln>  1</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>rf</span><span class=w> </span><span class=o>*</span><span class=nx>Raft</span><span class=p>)</span><span class=w> </span><span class=nf>startElection</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>  2</span><span class=cl><span class=w>	</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>  3</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>  4</span><span class=cl><span class=w>	</span><span class=c1>// Tigger election, send RequestVote RPC</span><span class=w>
</span></span></span><span class=line><span class=ln>  5</span><span class=cl><span class=w>	</span><span class=c1>// Once you have voted for someone in a term the elction timeout should be reset</span><span class=w>
</span></span></span><span class=line><span class=ln>  6</span><span class=cl><span class=w>	</span><span class=c1>// Reset election timer for self</span><span class=w>
</span></span></span><span class=line><span class=ln>  7</span><span class=cl><span class=w>	</span><span class=nx>rf</span><span class=p>.</span><span class=nx>lastContactFromLeader</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>  8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>  9</span><span class=cl><span class=w>	</span><span class=c1>// Reset the election timeout with new value</span><span class=w>
</span></span></span><span class=line><span class=ln> 10</span><span class=cl><span class=w>	</span><span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimeout</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=mi>1500</span><span class=o>+</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Int63</span><span class=p>()</span><span class=o>%</span><span class=mi>1500</span><span class=p>))</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=w>
</span></span></span><span class=line><span class=ln> 11</span><span class=cl><span class=w>	</span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=c1>// increase term</span><span class=w>
</span></span></span><span class=line><span class=ln> 12</span><span class=cl><span class=w>	</span><span class=nx>rf</span><span class=p>.</span><span class=nx>state</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>StateCandidate</span><span class=w>
</span></span></span><span class=line><span class=ln> 13</span><span class=cl><span class=w>	</span><span class=nx>peerCount</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>peers</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 14</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 15</span><span class=cl><span class=w>	</span><span class=nx>voteCount</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=c1>// self vote</span><span class=w>
</span></span></span><span class=line><span class=ln> 16</span><span class=cl><span class=w>	</span><span class=nx>lastLogIndex</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>log</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln> 17</span><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>lastLogTerm</span><span class=w> </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=ln> 18</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 19</span><span class=cl><span class=w>	</span><span class=nx>done</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=ln> 20</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 21</span><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>lastLogIndex</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 22</span><span class=cl><span class=w>		</span><span class=nx>lastLogTerm</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>log</span><span class=p>[</span><span class=nx>lastLogIndex</span><span class=p>].</span><span class=nx>Term</span><span class=w>
</span></span></span><span class=line><span class=ln> 23</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>snapshotLastLogIndex</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 24</span><span class=cl><span class=w>		</span><span class=nx>lastLogTerm</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>snapshotLastLogTerm</span><span class=w>
</span></span></span><span class=line><span class=ln> 25</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 26</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 27</span><span class=cl><span class=w>	</span><span class=nx>lastLogIndex</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>snapshotLastLogIndex</span><span class=w>
</span></span></span><span class=line><span class=ln> 28</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 29</span><span class=cl><span class=w>	</span><span class=nx>rf</span><span class=p>.</span><span class=nf>persist</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 30</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 31</span><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Candidate: %d | Election Ticker]: Election timout! Initiating election for term %d, with lastLogIndex: %d &amp; lastLogTerm: %d.\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span><span class=w> </span><span class=nx>lastLogIndex</span><span class=p>,</span><span class=w> </span><span class=nx>lastLogTerm</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 32</span><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Candidate: %d | Election Ticker]: Election timeout reset to: %v.\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimeout</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 33</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 34</span><span class=cl><span class=w>	</span><span class=nx>args</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>RequestVoteArgs</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 35</span><span class=cl><span class=w>		</span><span class=nx>Term</span><span class=p>:</span><span class=w>         </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 36</span><span class=cl><span class=w>		</span><span class=nx>CandidateId</span><span class=p>:</span><span class=w>  </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 37</span><span class=cl><span class=w>		</span><span class=nx>LastLogIndex</span><span class=p>:</span><span class=w> </span><span class=nx>lastLogIndex</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 38</span><span class=cl><span class=w>		</span><span class=nx>LastLogTerm</span><span class=p>:</span><span class=w>  </span><span class=nx>lastLogTerm</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 39</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 40</span><span class=cl><span class=w>	</span><span class=nx>requestVoteResponses</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=o>*</span><span class=nx>RequestVoteReply</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 41</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 42</span><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=nx>peerIndex</span><span class=p>,</span><span class=w> </span><span class=nx>peer</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>peers</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 43</span><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>peerIndex</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 44</span><span class=cl><span class=w>			</span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>peer</span><span class=w> </span><span class=o>*</span><span class=nx>labrpc</span><span class=p>.</span><span class=nx>ClientEnd</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 45</span><span class=cl><span class=w>				</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 46</span><span class=cl><span class=w>				</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>done</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 47</span><span class=cl><span class=w>					</span><span class=c1>// Either majority is achieved or candidate is stepping down as candidate</span><span class=w>
</span></span></span><span class=line><span class=ln> 48</span><span class=cl><span class=w>					</span><span class=c1>// Dont wait for this peer&#39;s RequestVote RPC response and exit this goroutine</span><span class=w>
</span></span></span><span class=line><span class=ln> 49</span><span class=cl><span class=w>					</span><span class=c1>// to prevent goroutine leak</span><span class=w>
</span></span></span><span class=line><span class=ln> 50</span><span class=cl><span class=w>					</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln> 51</span><span class=cl><span class=w>				</span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 52</span><span class=cl><span class=w>					</span><span class=nx>reply</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>RequestVoteReply</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=ln> 53</span><span class=cl><span class=w>					</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Candidate: %d | Election Ticker]: Requesting vote from peer: %d.\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span><span class=w> </span><span class=nx>peerIndex</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 54</span><span class=cl><span class=w>					</span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>peer</span><span class=p>.</span><span class=nf>Call</span><span class=p>(</span><span class=s>&#34;Raft.RequestVote&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>,</span><span class=w> </span><span class=nx>reply</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 55</span><span class=cl><span class=w>					</span><span class=k>if</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 56</span><span class=cl><span class=w>						</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 57</span><span class=cl><span class=w>						</span><span class=k>case</span><span class=w> </span><span class=nx>requestVoteResponses</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>reply</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 58</span><span class=cl><span class=w>						</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>done</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 59</span><span class=cl><span class=w>							</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln> 60</span><span class=cl><span class=w>						</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 61</span><span class=cl><span class=w>					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 62</span><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 63</span><span class=cl><span class=w>			</span><span class=p>}(</span><span class=nx>peer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 64</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 65</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 66</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 67</span><span class=cl><span class=w>	</span><span class=c1>// Releasing the lock after making RPC calls</span><span class=w>
</span></span></span><span class=line><span class=ln> 68</span><span class=cl><span class=w>	</span><span class=c1>// Each RPC call for RequestVote is in its own thread so its not blocking</span><span class=w>
</span></span></span><span class=line><span class=ln> 69</span><span class=cl><span class=w>	</span><span class=c1>// We can release the lock after spawning RequestVote RPC thread for each peer</span><span class=w>
</span></span></span><span class=line><span class=ln> 70</span><span class=cl><span class=w>	</span><span class=c1>// Before releasing the lock lets make copy of some state to verify sanity</span><span class=w>
</span></span></span><span class=line><span class=ln> 71</span><span class=cl><span class=w>	</span><span class=c1>// After reacquiring the lock</span><span class=w>
</span></span></span><span class=line><span class=ln> 72</span><span class=cl><span class=w>	</span><span class=nx>electionTerm</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w>
</span></span></span><span class=line><span class=ln> 73</span><span class=cl><span class=w>	</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln> 74</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 75</span><span class=cl><span class=w>	</span><span class=nx>majority</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>peerCount</span><span class=o>/</span><span class=mi>2</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln> 76</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 77</span><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>peerCount</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 78</span><span class=cl><span class=w>		</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 79</span><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>requestVoteResponses</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 80</span><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nf>killed</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 81</span><span class=cl><span class=w>				</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Candidate: %d | Election Ticker]: Candidate killed while waiting for peer RequestVote response. Aborting election process.\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 82</span><span class=cl><span class=w>				</span><span class=nb>close</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span><span class=w> </span><span class=c1>// Signal all other RequestVote goroutines to stop</span><span class=w>
</span></span></span><span class=line><span class=ln> 83</span><span class=cl><span class=w>				</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln> 84</span><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 85</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 86</span><span class=cl><span class=w>			</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln> 87</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 88</span><span class=cl><span class=w>			</span><span class=c1>// State stale after RequestVote RPC</span><span class=w>
</span></span></span><span class=line><span class=ln> 89</span><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>electionTerm</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>StateCandidate</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 90</span><span class=cl><span class=w>				</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln> 91</span><span class=cl><span class=w>				</span><span class=nb>close</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 92</span><span class=cl><span class=w>				</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln> 93</span><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 94</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 95</span><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>Term</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 96</span><span class=cl><span class=w>				</span><span class=c1>// A follower voted for someone else</span><span class=w>
</span></span></span><span class=line><span class=ln> 97</span><span class=cl><span class=w>				</span><span class=c1>// If they voted for same term then we can ignore</span><span class=w>
</span></span></span><span class=line><span class=ln> 98</span><span class=cl><span class=w>				</span><span class=c1>// But if term number is higher than our current term then</span><span class=w>
</span></span></span><span class=line><span class=ln> 99</span><span class=cl><span class=w>				</span><span class=c1>// we should step from candidate to follower and update our term as well</span><span class=w>
</span></span></span><span class=line><span class=ln>100</span><span class=cl><span class=w>				</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Candidate: %d | Election Ticker]: Stepping down as Candidate, Recieved RequestVoteReply with term value %d &gt; %d - my currentTerm.\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>101</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>102</span><span class=cl><span class=w>				</span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>Term</span><span class=w>
</span></span></span><span class=line><span class=ln>103</span><span class=cl><span class=w>				</span><span class=nx>rf</span><span class=p>.</span><span class=nx>state</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>StateFollower</span><span class=w>
</span></span></span><span class=line><span class=ln>104</span><span class=cl><span class=w>				</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>105</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>106</span><span class=cl><span class=w>				</span><span class=nx>rf</span><span class=p>.</span><span class=nf>persist</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>107</span><span class=cl><span class=w>				</span><span class=nb>close</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>108</span><span class=cl><span class=w>				</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>109</span><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>110</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>111</span><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>VoteGranted</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>112</span><span class=cl><span class=w>				</span><span class=nx>voteCount</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=ln>113</span><span class=cl><span class=w>				</span><span class=k>if</span><span class=w> </span><span class=nx>voteCount</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=nx>majority</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>114</span><span class=cl><span class=w>					</span><span class=c1>// Won election</span><span class=w>
</span></span></span><span class=line><span class=ln>115</span><span class=cl><span class=w>					</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Candidate: %d | Election Ticker]: Election won with %d/%d majority! New Leader:%d.\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span><span class=w> </span><span class=nx>voteCount</span><span class=p>,</span><span class=w> </span><span class=nx>peerCount</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>116</span><span class=cl><span class=w>					</span><span class=nx>rf</span><span class=p>.</span><span class=nx>state</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>StateLeader</span><span class=w>
</span></span></span><span class=line><span class=ln>117</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>118</span><span class=cl><span class=w>					</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>119</span><span class=cl><span class=w>					</span><span class=nb>close</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>120</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>121</span><span class=cl><span class=w>					</span><span class=nx>rf</span><span class=p>.</span><span class=nf>setupLeader</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>122</span><span class=cl><span class=w>					</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>123</span><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>124</span><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>125</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>126</span><span class=cl><span class=w>			</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>127</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>128</span><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimeout</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=ln>129</span><span class=cl><span class=w>			</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>130</span><span class=cl><span class=w>			</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[Candidate: %d | Election Ticker]: Election timeout! Wrapping up election for term: %d. Got %d votes. Current state = %d. Current set term: %d.\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span><span class=w> </span><span class=nx>electionTerm</span><span class=p>,</span><span class=w> </span><span class=nx>voteCount</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>state</span><span class=p>,</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>131</span><span class=cl><span class=w>			</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>132</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>133</span><span class=cl><span class=w>			</span><span class=nb>close</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>134</span><span class=cl><span class=w>			</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>135</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>136</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>137</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>138</span><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Within <code>startElection</code>, we construct <code>RequestVoteArgs</code> and concurrently dispatch the RPC to every peer using separate goroutines for each call. A <code>done</code> channel is also provided to these goroutines to signal events such as:</p><ul><li>Election cancellation, occurring if the Candidate reverts to Follower status, potentially after sending initial <code>RequestVote</code> RPCs upon receiving a heartbeat OR a <code>RequestVote</code> RPC from another peer whose Term is at least the Candidate&rsquo;s current Term.</li><li>Cancellation of waiting for <code>RequestVote</code> RPC responses if a majority has been secured or the election timeout is reached.</li><li>It&rsquo;s worth noting that after sending RPC calls to each peer, <em>we release the lock</em>. This prevents us from blocking other incoming messages to that peer while awaiting RPC responses. This is why we use the <code>done</code> Go channel. It ensures that any concurrent request from elsewhere that modifies the candidate&rsquo;s status is notified. This happens when the <code>done</code> channel is closed, causing the <code>case &lt;-done:</code> statement to return first in the <code>select</code> block.</li></ul><p><a href=https://pdos.csail.mit.edu/6.824/labs/lab-raft1.html>6.5840 Labs</a> provide us with following test cases for leader election:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=ln>1</span><span class=cl>❯ go <span class=nb>test</span> -run 3A
</span></span><span class=line><span class=ln>2</span><span class=cl>Test <span class=o>(</span>3A<span class=o>)</span>: initial election <span class=o>(</span>reliable network<span class=o>)</span>...
</span></span><span class=line><span class=ln>3</span><span class=cl>  ... Passed --  <span class=nb>time</span>  5.5s <span class=c1>#peers 3 #RPCs    36 #Ops    0</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>Test <span class=o>(</span>3A<span class=o>)</span>: election after network failure <span class=o>(</span>reliable network<span class=o>)</span>...
</span></span><span class=line><span class=ln>5</span><span class=cl>  ... Passed --  <span class=nb>time</span>  8.4s <span class=c1>#peers 3 #RPCs    50 #Ops    0</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>Test <span class=o>(</span>3A<span class=o>)</span>: multiple elections <span class=o>(</span>reliable network<span class=o>)</span>...
</span></span><span class=line><span class=ln>7</span><span class=cl>  ... Passed --  <span class=nb>time</span> 16.9s <span class=c1>#peers 7 #RPCs   382 #Ops    0</span>
</span></span><span class=line><span class=ln>8</span><span class=cl>PASS
</span></span><span class=line><span class=ln>9</span><span class=cl>ok      6.5840/raft1    31.352s
</span></span></code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>In this part we understood how RAFT manages a replicated log across a cluster of machines, ensuring consistency and availability. The post details the roles of leader, follower, and candidate, along with the key concepts of terms, log entries, leader election, and log replication. Crucial mechanisms, such as checks on <code>RequestVote</code> and <code>AppendEntries</code> RPCs and random timeouts, guarantee leader accuracy and prevent split votes. The post lays the groundwork for understanding how RAFT ensures that committed log entries are never lost and how a valid leader is reliably elected.</p><p>In subsequent parts, we will see how we set up a leader when a candidate wins election and how we handle leader stepping down from leadership. Then we will see how log replication actually happens along with cases of log conflicts and log corrections by leader and how heartbeats helps to achieve that, In the end we will trace a client request to see the behaviour of this distributed cluster seen as a single machine from client&rsquo;s point of view.</p><h1 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h1><ul><li><a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf>https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf</a></li><li>Leader Election<a href=https://thesecretlivesofdata.com/raft/#election> Visualization</a></li><li><a href=https://thesquareplanet.com/blog/students-guide-to-raft/>https://thesquareplanet.com/blog/students-guide-to-raft/</a></li><li>Implementation: <a href=https://github.com/harshrai654/6.5840/blob/master/src/raft1/raft.go>https://github.com/harshrai654/6.5840/blob/master/src/raft1/raft.go</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://harshrai654.github.io/blogs/tags/%23replication/>#Replication</a></li><li><a href=https://harshrai654.github.io/blogs/tags/%23leader-election/>#Leader-Election</a></li></ul><nav class=paginav><a class=prev href=https://harshrai654.github.io/blogs/building-fault-tolerant-kv-storage-system---part-2/><span class=title>« Prev</span><br><span>Building Fault Tolerant KV Storage System - Part 2</span>
</a><a class=next href=https://harshrai654.github.io/blogs/map-reduce/><span class=title>Next »</span><br><span>Map Reduce</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Fault Tolerant KV Storage System - Part 1 on x" href="https://x.com/intent/tweet/?text=Building%20Fault%20Tolerant%20KV%20Storage%20System%20-%20Part%201&amp;url=https%3a%2f%2fharshrai654.github.io%2fblogs%2fbuilding-fault-tolerant-kv-storage-system---part-1%2f&amp;hashtags=%23Replication%2c%23Leader-Election"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Fault Tolerant KV Storage System - Part 1 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fharshrai654.github.io%2fblogs%2fbuilding-fault-tolerant-kv-storage-system---part-1%2f&amp;title=Building%20Fault%20Tolerant%20KV%20Storage%20System%20-%20Part%201&amp;summary=Building%20Fault%20Tolerant%20KV%20Storage%20System%20-%20Part%201&amp;source=https%3a%2f%2fharshrai654.github.io%2fblogs%2fbuilding-fault-tolerant-kv-storage-system---part-1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Fault Tolerant KV Storage System - Part 1 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fharshrai654.github.io%2fblogs%2fbuilding-fault-tolerant-kv-storage-system---part-1%2f&title=Building%20Fault%20Tolerant%20KV%20Storage%20System%20-%20Part%201"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Fault Tolerant KV Storage System - Part 1 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fharshrai654.github.io%2fblogs%2fbuilding-fault-tolerant-kv-storage-system---part-1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Fault Tolerant KV Storage System - Part 1 on whatsapp" href="https://api.whatsapp.com/send?text=Building%20Fault%20Tolerant%20KV%20Storage%20System%20-%20Part%201%20-%20https%3a%2f%2fharshrai654.github.io%2fblogs%2fbuilding-fault-tolerant-kv-storage-system---part-1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Fault Tolerant KV Storage System - Part 1 on telegram" href="https://telegram.me/share/url?text=Building%20Fault%20Tolerant%20KV%20Storage%20System%20-%20Part%201&amp;url=https%3a%2f%2fharshrai654.github.io%2fblogs%2fbuilding-fault-tolerant-kv-storage-system---part-1%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Fault Tolerant KV Storage System - Part 1 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Building%20Fault%20Tolerant%20KV%20Storage%20System%20-%20Part%201&u=https%3a%2f%2fharshrai654.github.io%2fblogs%2fbuilding-fault-tolerant-kv-storage-system---part-1%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://harshrai654.github.io/blogs/>Learning Loop</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script type=module>
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs";

  
  function isDarkMode() {
    return (
      document.body.classList.contains("dark") ||
      localStorage.getItem("pref-theme") === "dark" ||
      (!localStorage.getItem("pref-theme") &&
        window.matchMedia("(prefers-color-scheme: dark)").matches)
    );
  }

  
  mermaid.initialize({
    startOnLoad: true,
    theme: isDarkMode() ? "dark" : "default",
    themeVariables: {
      dark: {
        primaryColor: "#ff6b6b",
        primaryTextColor: "#ffffff",
        primaryBorderColor: "#ff6b6b",
        lineColor: "#ffffff",
        secondaryColor: "#4ecdc4",
        tertiaryColor: "#45b7d1",
        background: "#1a1a1a",
        mainBkg: "#2d2d2d",
        secondBkg: "#3d3d3d",
        tertiaryBkg: "#4d4d4d",
      },
      default: {
        primaryColor: "#ff6b6b",
        primaryTextColor: "#000000",
        primaryBorderColor: "#ff6b6b",
        lineColor: "#000000",
        secondaryColor: "#4ecdc4",
        tertiaryColor: "#45b7d1",
      },
    },
  });

  
  const themeToggle = document.getElementById("theme-toggle");
  if (themeToggle) {
    themeToggle.addEventListener("click", () => {
      setTimeout(() => {
        mermaid.initialize({
          startOnLoad: false,
          theme: isDarkMode() ? "dark" : "default",
          themeVariables: {
            dark: {
              primaryColor: "#ff6b6b",
              primaryTextColor: "#ffffff",
              primaryBorderColor: "#ff6b6b",
              lineColor: "#ffffff",
              secondaryColor: "#4ecdc4",
              tertiaryColor: "#45b7d1",
              background: "#1a1a1a",
              mainBkg: "#2d2d2d",
              secondBkg: "#3d3d3d",
              tertiaryBkg: "#4d4d4d",
            },
            default: {
              primaryColor: "#ff6b6b",
              primaryTextColor: "#000000",
              primaryBorderColor: "#ff6b6b",
              lineColor: "#000000",
              secondaryColor: "#4ecdc4",
              tertiaryColor: "#45b7d1",
            },
          },
        });

        
        document.querySelectorAll(".mermaid").forEach((element) => {
          element.removeAttribute("data-processed");
          mermaid.init(undefined, element);
        });
      }, 100);
    });
  }
</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>