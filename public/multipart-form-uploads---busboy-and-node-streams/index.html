<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/blogs/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blogs/livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Multipart Form Uploads - Busboy and Node Streams | Learning Loop</title>
<meta name="keywords" content="Networking, Memory, TCP, OS, NodeJS">
<meta name="description" content="I was recently investigating ways to improve the efficiency of file uploads to a Node.js server. This need arose after encountering a production bug where the absence of a maximum file size limit for uploads led to an out-of-memory crash due to file buffers consuming excessive heap memory. In this Node.js server, I was using Express and express-openapi-validator to document the server&rsquo;s API with an OpenAPI specification. express-openapi-validator utilizes multer for file uploads. I had previously encountered this library whenever file uploads from forms needed to be handled in Node.js, but I never questioned why a separate library was necessary for file uploads. This time, I decided to go deeper to understand if a dedicated package for file uploads is truly needed, and if so, what specific benefits Multer or similar libraries provide.
I initially needed to find a configuration option in express-openapi-validator to set a request-wide limit on the maximum size (in bytes) of data allowed in a request, including all file attachments.  The express-openapi-validator package offers a fileUploader configuration (fileUploader documentation) that passes options directly to multer.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/blogs/multipart-form-uploads---busboy-and-node-streams/">
<link crossorigin="anonymous" href="/blogs/assets/css/stylesheet.3100c559f5e5f9a03f24d0f501a11025c11322dfc9520791d926b4086ca75994.css" integrity="sha256-MQDFWfXl&#43;aA/JND1AaEQJcETIt/JUgeR2Sa0CGynWZQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/blogs/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/blogs/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/blogs/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/blogs/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/blogs/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/blogs/multipart-form-uploads---busboy-and-node-streams/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript> 
<script
  data-goatcounter="https://ttharsh.goatcounter.com/count"
  async
  src="//gc.zgo.at/count.js"
></script>


</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/blogs/" accesskey="h" title="Learning Loop (Alt + H)">Learning Loop</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/blogs/">Home</a></div>
    <h1 class="post-title entry-hint-parent">
      Multipart Form Uploads - Busboy and Node Streams
    </h1>
    <div class="post-meta"><span title='2025-10-12 00:48:38 +0530 IST'>October 12, 2025</span>&nbsp;·&nbsp;17 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#streams-in-nodejs" aria-label="Streams in NodeJS">Streams in NodeJS</a></li>
                <li>
                    <a href="#busboy-implementation--new-limit-config" aria-label="Busboy Implementation &amp; New Limit Config">Busboy Implementation &amp; New Limit Config</a><ul>
                        
                <li>
                    <a href="#how-busboy-parses-the-multipart-stream" aria-label="How Busboy Parses the Multipart Stream">How Busboy Parses the Multipart Stream</a></li>
                <li>
                    <a href="#busboys-back-pressure-handling" aria-label="Busboy&#39;s Back pressure Handling">Busboy's Back pressure Handling</a></li></ul>
                </li>
                <li>
                    <a href="#wrapping-up" aria-label="Wrapping Up">Wrapping Up</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>I was recently investigating ways to improve the efficiency of file uploads to a Node.js server. This need arose after encountering a production bug where the absence of a maximum file size limit for uploads led to an out-of-memory crash due to file buffers consuming excessive heap memory. In this Node.js server, I was using Express and <code>express-openapi-validator</code> to document the server&rsquo;s API with an <code>OpenAPI</code> specification. <code>express-openapi-validator</code> utilizes <code>multer</code> for file uploads. I had previously encountered this library whenever file uploads from forms needed to be handled in Node.js, but I never questioned why a separate library was necessary for file uploads. This time, I decided to go deeper to understand if a dedicated package for file uploads is truly needed, and if so, what specific benefits <code>Multer</code> or similar libraries provide.
I initially needed to find a configuration option in <code>express-openapi-validator</code> to set a request-wide limit on the maximum size (in bytes) of data allowed in a request, including all file attachments.  The <code>express-openapi-validator</code> package offers a <code>fileUploader</code> configuration (<a href="https://cdimascio.github.io/express-openapi-validator-documentation/usage-file-uploader/">fileUploader documentation</a>) that passes options directly to <code>multer</code>.</p>
<p>Therefore, I checked the <code>multer</code> documentation and discovered the <code>limits</code> configuration option (<a href="https://github.com/expressjs/multer?tab=readme-ov-file#limits">multer limits documentation</a>), which perfectly suited the needs. <code>multer</code> uses <code>busboy</code> to handle the parsing of multipart form data in a stream fashion. Consequently, the <code>limits</code> options defined in <code>multer</code> are actually passed directly to <code>busboy</code>, and represent <code>busboy's</code> limit configurations.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-md" data-lang="md"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">-</span> **limits** - <span class="ge">_object_</span> - Various limits on incoming data. Valid properties are:
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="k">-</span> **fieldNameSize** - <span class="ge">_integer_</span> - Max field name size (in bytes). <span class="gs">**Default:**</span> <span class="sb">`100`</span>.
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="k">-</span> **fieldSize** - <span class="ge">_integer_</span> - Max field value size (in bytes). <span class="gs">**Default:**</span> <span class="sb">`1048576`</span> (1MB).
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="k">-</span> **fields** - <span class="ge">_integer_</span> - Max number of non-file fields. <span class="gs">**Default:**</span> <span class="sb">`Infinity`</span>.
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="k">-</span> **fileSize** - <span class="ge">_integer_</span> - For multipart forms, the max file size (in bytes). <span class="gs">**Default:**</span> <span class="sb">`Infinity`</span>.
</span></span><span class="line"><span class="ln">10</span><span class="cl">	
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="k">-</span> **files** - <span class="ge">_integer_</span> - For multipart forms, the max number of file fields. <span class="gs">**Default:**</span> <span class="sb">`Infinity`</span>.
</span></span><span class="line"><span class="ln">12</span><span class="cl">	
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="k">-</span> **parts** - <span class="ge">_integer_</span> - For multipart forms, the max number of parts (fields + files). <span class="gs">**Default:**</span> <span class="sb">`Infinity`</span>.
</span></span><span class="line"><span class="ln">14</span><span class="cl">	
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="k">-</span> **headerPairs** - <span class="ge">_integer_</span> - For multipart forms, the max number of header key-value pairs to parse. <span class="gs">**Default:**</span> <span class="sb">`2000`</span> (same as node&#39;s http module).
</span></span></code></pre></div><p>So, based on the available options, I can have a per-file-based size limit along with a limit on the number of files.  However, that wasn&rsquo;t quite what I needed, since the requirement wasn&rsquo;t just to cap the <em>number</em> of files, but to limit the overall request upload size.  Eventually, I stumbled upon <a href="https://github.com/mscdex/busboy/issues/367">this feature request</a> in the <code>busboy</code> repository, which addressed exactly what I wanted.  This discovery kicked off a intresting exploration of how <code>busboy</code> handles multipart form data.  It led to uncovering many details regarding <strong>back pressure</strong> in streams, how <strong>TCP control flow windows</strong> help in maintaining back pressure, and all this in an effort to contribute a request-wide total size limit configuration option to <code>busboy</code>. </p>
<h2 id="streams-in-nodejs">Streams in NodeJS<a hidden class="anchor" aria-hidden="true" href="#streams-in-nodejs">#</a></h2>
<p>Let&rsquo;s first look at an example usage of <code>busboy</code> with plain old HTTP server in Node.js</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kr">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kr">const</span> <span class="nx">busboy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;busboy&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;POST&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;POST request&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="kr">const</span> <span class="nx">bb</span> <span class="o">=</span> <span class="nx">busboy</span><span class="p">({</span> <span class="nx">headers</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span> <span class="p">});</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="nx">bb</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">      <span class="kr">const</span> <span class="p">{</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">mimeType</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">info</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="sb">`File [</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">]: filename: %j, encoding: %j, mimeType: %j`</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="nx">filename</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="nx">encoding</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="nx">mimeType</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">      <span class="nx">file</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`File [</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">] got </span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> bytes`</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">      <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`File [</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">] done`</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="nx">bb</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Field [</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">]: value: %j`</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="nx">bb</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Done parsing form!&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">303</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Connection</span><span class="o">:</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">Location</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span> <span class="p">});</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">    <span class="nx">req</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Listening for requests&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>Looking at the code, the <code>req</code> object (a <code>Readable</code> stream) is piped into the <code>busboy</code> instance (<code>bb</code>). This <code>bb</code> instance returns a <code>MultiPart</code> class object (specifically, an instance of the class found <a href="https://github.com/mscdex/busboy/blob/master/lib/types/multipart.js#L221">here</a>), which inherits from <code>Writable</code>.</p>
<p>The <code>Readable</code> and <code>Writable</code> streams have several methods that are invoked at different times during operations such as <code>read</code>, <code>write</code>, and <code>pause</code>. Because each stream relies on the consumer downstream and the producer upstream, Node.js buffers the generated data by default if there&rsquo;s backpressure in the stream pipeline. You can find more information about this in the Node.js <a href="https://nodejs.org/api/stream.html#buffering">documentation</a>:</p>
<blockquote>
<p>Both <a href="https://nodejs.org/api/stream.html#class-streamwritable"><code>Writable</code></a> and <a href="https://nodejs.org/api/stream.html#class-streamreadable"><code>Readable</code></a> streams will store data in an internal buffer.
The amount of data potentially buffered depends on the <code>highWaterMark</code> option passed into the stream&rsquo;s constructor. For normal streams, the <code>highWaterMark</code> option specifies a <a href="https://nodejs.org/api/stream.html#highwatermark-discrepancy-after-calling-readablesetencoding">total number of bytes</a>.
Data is buffered in <code>Readable</code> streams when the implementation calls <a href="https://nodejs.org/api/stream.html#readablepushchunk-encoding"><code>stream.push(chunk)</code></a>. If the consumer of the Stream does not call <a href="https://nodejs.org/api/stream.html#readablereadsize"><code>stream.read()</code></a>, the data will sit in the internal queue until it is consumed.
Once the total size of the internal read buffer reaches the threshold specified by <code>highWaterMark</code>, the stream will temporarily stop reading data from the underlying resource until the data currently buffered can be consumed (that is, the stream will stop calling the internal <a href="https://nodejs.org/api/stream.html#readable_readsize"><code>readable._read()</code></a> method that is used to fill the read buffer).
Data is buffered in <code>Writable</code> streams when the <a href="https://nodejs.org/api/stream.html#writablewritechunk-encoding-callback"><code>writable.write(chunk)</code></a> method is called repeatedly. While the total size of the internal write buffer is below the threshold set by <code>highWaterMark</code>, calls to <code>writable.write()</code> will return <code>true</code>. Once the size of the internal buffer reaches or exceeds the <code>highWaterMark</code>, <code>false</code> will be returned.</p></blockquote>
<p>A key goal of the <code>stream</code> API, particularly the <a href="https://nodejs.org/api/stream.html#readablepipedestination-options"><code>stream.pipe()</code></a> method, is to limit the buffering of data to acceptable levels such that sources and destinations of differing speeds will not overwhelm the available memory.</p>
<p>To understand the idea discussed above in the docs let&rsquo;s take an example:
If your server does something like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln">1</span><span class="cl"><span class="kr">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="s1">&#39;file.bin&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nx">req</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">ws</span><span class="p">);</span>
</span></span></code></pre></div><p>Then data flows like this:</p>
<pre tabindex="0"><code>[TCP socket] → [IncomingMessage (Readable)] → [Writable File Stream] → [disk]
</code></pre><p>But these components run at different speeds:</p>
<ul>
<li>The <strong>network producer</strong> (socket) might push data quickly.</li>
<li>The <strong>file system consumer</strong> might be slower (e.g., disk I/O, file system buffering).
So Node.js stream buffering ensures that:</li>
<li>The <code>Readable</code> (<code>req</code>) will stop calling its internal <code>_read()</code> once its internal buffer exceeds its <code>highWaterMark</code>.</li>
<li>The <code>Writable</code> (<code>fs.WriteStream</code>) will signal backpressure by returning <code>false</code> from <code>.write()</code>, which will pause the <code>Readable</code> until the buffer drains.</li>
</ul>
<pre tabindex="0"><code>┌────────────────────┐
│   Network Socket   │   (Producer)
│   [TCP Stream]     │
└────────┬───────────┘
         │  data chunks →
         ▼  req.push(chunk)
┌────────────────────┐
│  IncomingMessage   │   (Readable Stream)
│  Internal Buffer   │
│  highWaterMark = 16KB
│  [Buffered: █████░░░░░░] 12KB / 16KB
└────────┬───────────┘
         │  
         │  ws.write(chunk) → called internally after pipe
         ▼
┌────────────────────┐
│  File WriteStream  │   (Writable Stream)
│  Internal Buffer   │
│  highWaterMark = 64KB
│  [Buffered: ████░░░░░░░░] 20KB / 64KB
└────────┬───────────┘
         │  fs.write(chunk)
         ▼
┌────────────────────┐
│     Disk I/O       │   (Slow Consumer)
│  write operation → │
└────────────────────┘
</code></pre><p>As you can see above, if <code>Disk I/O</code> is slower than the rate at which we are receiving chunks from the TCP socket, the <code>ws.write</code> call will continue buffering incoming chunks into its internal memory buffer until it reaches its <code>highWaterMark</code> (64KB in this case). Once the buffer is full, <code>ws.write</code> returns <code>false</code>, signalling the stream above it that the downstream consumer is slower.
The <code>IncomingMessage</code> (<code>req</code>), being a readable stream, will then start buffering the chunks coming from the TCP socket in its own internal buffer (16KB <code>highWaterMark</code>). When this buffer fills up, <code>req.push</code> will also return <code>false</code>, indicating it cannot accept more data for now. This backpressure propagates upstream and eventually affects the TCP socket itself, which the OS handles via <strong>TCP flow control</strong> - essentially slowing down the sender to prevent memory overload.</p>
<p>At the OS level, each TCP socket has its own kernel buffer. Normally, data flows like this:</p>
<pre tabindex="0"><code>TCP socket kernel buffer → 
user-space buffer → 
writable stream buffer → 
filesystem buffer → 
disk
</code></pre><p>Each step involves memory copies. In some cases, if we don’t need to parse or modify the data (like streaming raw uploads to disk), we can bypass user-space entirely using zero-copy techniques, transferring data directly from the socket kernel buffer to the filesystem kernel buffer. This avoids redundant memory copies and improves performance, at the cost of not being able to inspect or modify the data before it’s written.
For a deeper dive into TCP connections, sockets, and file descriptors, you can check out my detailed write-up <a href="/blogs/socket-file-descriptor-and-tcp-connections/">here</a>.</p>
<h2 id="busboy-implementation--new-limit-config"><code>Busboy</code> Implementation &amp; New Limit Config<a hidden class="anchor" aria-hidden="true" href="#busboy-implementation--new-limit-config">#</a></h2>
<p>Now that we have a basic understanding of how data moves through the <code>IncomingRequest</code> object in an HTTP server, let&rsquo;s address the initial question: why do we need Busboy, and what problem does it solve?
Busboy is a parser for <code>formdata</code>. We&rsquo;ve already seen how we pipe the readable stream <code>req</code> output to Busboy&rsquo;s multipart writable stream. Before examining the data flow within Busboy, let&rsquo;s understand <code>multipart/form-data</code>.
Below is an example of <code>multipart/form-data</code>. We will focus primarily on file uploads for this form, rather than fields.</p>
<pre tabindex="0"><code>POST /upload HTTP/1.1
Host: example.com
User-Agent: curl/8.0.1
Accept: */*
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Length: 512

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name=&#34;file1&#34;; filename=&#34;file1.txt&#34;
Content-Type: text/plain

Hello, this is the content of file1.txt.
It could be multiple lines.
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name=&#34;file2&#34;; filename=&#34;file2.jpg&#34;
Content-Type: image/jpeg

(binary data of file2.jpg would go here)
------WebKitFormBoundary7MA4YWxkTrZu0gW--
</code></pre><p>Breakdown of each part of the above raw HTTP <code>multipart/form-data</code></p>
<ol>
<li><strong>HTTP is a text protocol</strong>
<ul>
<li>Everything above is sent as plain text over a TCP connection (except the actual binary file contents).</li>
<li>The TCP stream is just a stream of bytes; it has no understanding of <strong>fields</strong> or <strong>files.</strong></li>
<li><strong>Node.js’s HTTP server reads this TCP stream and parses the start-line and headers</strong> (e.g., <code>POST /upload HTTP/1.1</code>, <code>Host</code>, <code>Content-Type</code>, <code>Content-Length</code>) so it can understand the request.</li>
<li>After the headers are parsed, the remaining bytes (the body) are exposed to <code>req</code> (<code>IncomingMessage</code>) as a readable stream.</li>
<li>This raw body byte stream is exactly what gets pushed into Busboy for parsing.</li>
</ul>
</li>
<li><strong>Boundary markers</strong>
<ul>
<li>The <code>boundary</code> string (<code>----WebKitFormBoundary7MA4YWxkTrZu0gW</code>) separates each part of the multipart request.</li>
<li>Each part starts with <code>--&lt;boundary&gt;</code> and the whole request ends with <code>--&lt;boundary&gt;--</code>.</li>
<li>Busboy parses these boundaries to identify where one field ends and another begins.</li>
</ul>
</li>
<li><strong>Headers for each part</strong>
<ul>
<li><code>Content-Disposition</code> gives the field name and filename.</li>
<li><code>Content-Type</code> tells the server what type of data is being sent.</li>
<li><strong>These headers are part of the raw text stream</strong>; without parsing them, the server cannot know the field names or file types.</li>
</ul>
</li>
<li><strong>Content / File data</strong>
<ul>
<li>Text files are just plain text; binary files are raw bytes included inline in the TCP stream.</li>
<li>Node.js or any HTTP server cannot automatically separate the files from the TCP stream.</li>
<li><strong>Busboy (or similar parser) is required to convert this raw text+binary stream into usable file streams or buffers in user space.</strong></li>
<li>This is why a <strong>kernel -&gt; user-space memory copy</strong> is necessary: the server must access the bytes in user-space to parse headers, boundaries, and file contents.</li>
</ul>
</li>
<li><strong>Content-Length</strong>
<ul>
<li>Represents the total bytes of all boundaries, headers, and file data.</li>
<li>TCP itself only cares about sending bytes; the HTTP layer interprets them according to this length.</li>
</ul>
</li>
</ol>
<h3 id="how-busboy-parses-the-multipart-stream">How Busboy Parses the Multipart Stream<a hidden class="anchor" aria-hidden="true" href="#how-busboy-parses-the-multipart-stream">#</a></h3>
<p>The above raw stream of data is what gets piped to Busboy’s internal <code>Multipart</code> writeable stream.
Inside its constructor, Busboy initializes various <code>limits</code> based on the configuration provided. As part of the constructor logic, it creates a <code>HeaderParser</code> and sets up a <a href="https://github.com/mscdex/streamsearch">StreamSearch</a> instance with the multipart boundary string as the <em>needle</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">this</span><span class="p">.</span><span class="nx">_bparser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StreamSearch</span><span class="p">(</span><span class="sb">`\r\n--</span><span class="si">${</span><span class="nx">boundary</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="nx">ssCb</span><span class="p">);</span>
</span></span></code></pre></div><p><code>StreamSearch</code> calls the given callback <code>ssCb</code> whenever it encounters non-matching data or finds a match for the needle.<br>
In other words, as the raw <code>multipart/form-data</code> byte stream flows through, <code>StreamSearch</code> helps separate the actual boundaries from the data chunks in between, and passes those chunks to the provided callback for processing.
The callback <code>ssCb</code> is the core of the multipart parsing logic. During initialization, Busboy sets up several internal tracking variables, such as:</p>
<ul>
<li><strong><code>fileSize</code></strong> -  Tracks the size of the current file in bytes across all incoming chunks for that file. Once this reaches the configured <code>limits.fileSize</code>, Busboy stops processing additional chunks for that specific file and skips them until it encounters the next boundary (i.e., the start of a new field).</li>
<li><strong><code>files</code></strong> - Keeps track of the number of files seen so far. Once this count reaches <code>limits.files</code>, Busboy skips all subsequent file data until it detects the end of the form-data.
There are other similar limits and tracking variables initialized internally, but these two are the most relevant to the new feature we want to add:</li>
</ul>
<blockquote>
<p><strong>A global total file size limit across all uploaded files.</strong><br>
For example, if the limit is 50 MB, Busboy should process data only until the total size of all uploaded files reaches 50 MB. After that, it should skip any further chunks - even those belonging to new files - until it reaches the end of the form-data stream.</p></blockquote>
<p>To implement this, we’ll maintain a running counter similar to <code>fileSize</code>, but instead of resetting it per file, we’ll keep accumulating the total bytes processed across all files. Once it reaches <code>limits.totalFileSize</code>, we stop processing any further chunks for all files</p>
<p>For each segment identified by <code>ssCb</code>, the <code>HeaderParser</code> is invoked to inspect the <code>Content-Disposition</code> header. From this header, Busboy determines whether the part represents a regular form field or a file upload. If it’s a file, the <code>filename</code> is extracted, and the <code>files</code> counter is incremented.</p>
<p>As long as the number of processed files remains below <code>limits.files</code>, Busboy creates a new <code>Readable</code> stream for that file and emits a <code>file</code> event. This event carries both the file metadata and the associated stream, allowing your application to handle the file data as it arrives; for example, by piping it directly to a file or cloud storage.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kr">const</span> <span class="nx">hparser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HeaderParser</span><span class="p">((</span><span class="nx">header</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1">// ... 
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">files</span> <span class="o">===</span> <span class="nx">filesLimit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hitFilesLimit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">		<span class="nx">hitFilesLimit</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">		<span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;filesLimit&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="nx">skipPart</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="nx">fileSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="k">this</span><span class="p">.</span><span class="nx">_fileStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileStream</span><span class="p">(</span><span class="nx">fileOpts</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">  <span class="s1">&#39;file&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">  <span class="nx">partName</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">  <span class="k">this</span><span class="p">.</span><span class="nx">_fileStream</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">  <span class="p">{</span> <span class="nx">filename</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">	<span class="nx">encoding</span><span class="o">:</span> <span class="nx">partEncoding</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">	<span class="nx">mimeType</span><span class="o">:</span> <span class="nx">partType</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="c1"></span><span class="p">});</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="c1">// At the other end we can listen to the `file` event on busboy instance
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="c1"></span> <span class="nx">bb</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">  <span class="kr">const</span> <span class="nx">saveTo</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">tmpdir</span><span class="p">(),</span> <span class="sb">`busboy-upload-</span><span class="si">${</span><span class="nx">random</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">  <span class="nx">file</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">saveTo</span><span class="p">));</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>When the <code>file</code> event is triggered, the listener receives the stream of decoded file data - meaning by this point, the raw multipart byte stream from the TCP socket has been parsed and separated into meaningful file chunks by <code>Busboy's</code> internal <code>StreamSearch</code> and header parsing logic.
We can also see that when the file limit is reached, Busboy sets a boolean flag <code>hitFilesLimit</code> and emits the <code>filesLimit</code> event <strong>exactly once</strong> on the Busboy instance. This ensures that the user is notified only the first time the limit is exceeded.
In addition, <code>skipPart</code> is set to <code>true</code>. This flag tells the parser to <strong>ignore the rest of the current part’s body</strong> after finishing header parsing. Essentially, once we know we’ve hit the maximum number of allowed files, Busboy continues scanning the incoming stream but skips over any additional file data until it encounters the next boundary.
If the <code>limits.files</code> threshold has <strong>not</strong> been reached, the parser continues reading the body of the current file. For every incoming chunk of data, it updates the <code>fileSize</code> variable and ensures that only data up to the configured <code>fileSizeLimit</code> is passed downstream. Any excess bytes are truncated and trigger a <code>limit</code> event on the file stream.
Here’s the corresponding section of code that handles this logic:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">skipPart</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_fileStream</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">	<span class="kd">let</span> <span class="nx">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="kr">const</span> <span class="nx">actualLen</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">end</span> <span class="o">-</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">fileSizeLimit</span> <span class="o">-</span> <span class="nx">fileSize</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isDataSafe</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	  <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">allocUnsafe</span><span class="p">(</span><span class="nx">actualLen</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	  <span class="nx">data</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">actualLen</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	  <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">actualLen</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="nx">fileSize</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nx">fileSize</span> <span class="o">===</span> <span class="nx">fileSizeLimit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	  <span class="k">if</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">		<span class="k">this</span><span class="p">.</span><span class="nx">_fileStream</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	  <span class="k">this</span><span class="p">.</span><span class="nx">_fileStream</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">	  <span class="k">this</span><span class="p">.</span><span class="nx">_fileStream</span><span class="p">.</span><span class="nx">truncated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">	  <span class="nx">skipPart</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_fileStream</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">	  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_writecb</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">		<span class="k">this</span><span class="p">.</span><span class="nx">_fileStream</span><span class="p">.</span><span class="nx">_readcb</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_writecb</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">	  <span class="k">this</span><span class="p">.</span><span class="nx">_writecb</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The important part here is that the <strong><code>limit</code> event</strong> is fired only on the individual <code>FileStream</code> instance, not on the <code>Busboy</code> instance. This means the event listener attached to that particular file stream (usually through the <code>'file'</code> event handler on <code>Busboy</code>) can detect that the stream has been truncated because its size exceeded the per-file limit.</p>
<blockquote>
<p>With our new <strong><code>totalFileSize</code></strong> feature, however, we’ll extend this behavior,  A new event:  <code>totalSizelimit</code> event will be fired on <strong>both</strong> the <code>FileStream</code> and the <strong>Busboy instance</strong>. This is because exceeding the <code>totalFileSize</code> means the current file is truncated <strong>and</strong> no further file data across the entire request should be processed. The event now serves as a global signal to stop consumption of further reads as there won&rsquo;t be any more data parsed and pushed to the stream by <code>busboy</code> because of limits.</p></blockquote>
<h3 id="busboys-back-pressure-handling"><code>Busboy's</code> Back pressure Handling<a hidden class="anchor" aria-hidden="true" href="#busboys-back-pressure-handling">#</a></h3>
<p>If you look closely at the snippet above, you’ll also notice something interesting about how <code>Busboy</code> handles <strong>backpressure</strong>.
When <code>this._fileStream.push(chunk)</code> returns <strong><code>false</code></strong>, it means that <strong>the internal buffer of the <code>Readable</code> stream (<code>_fileStream</code>) itself is full</strong>, and therefore it’s temporarily unable to accept more data from its upstream producer: In this case, <code>Busboy’s</code> <code>Multipart</code> writable stream.
Here’s the nuance:</p>
<ul>
<li>The <code>FileStream</code> class in <code>Busboy</code> is a <strong>custom <code>Readable</code> stream</strong> that emits the parsed file data.</li>
<li><code>Busboy</code> (the <code>Multipart</code> writable) acts as the <strong>producer</strong> of that readable stream’s data.</li>
<li>When <code>Busboy</code> calls <code>fileStream.push(chunk)</code>:
<ul>
<li>If it returns <code>true</code>, it means the file stream’s internal buffer still has room it’s safe to push more data.</li>
<li>If it returns <code>false</code>, the file stream’s internal <code>highWaterMark</code> is reached  meaning it’s now buffering as much data as it can before its <em>slow consumer</em> (e.g., <code>fs.createWriteStream</code>) reads more.
That <strong>“slow consumer”</strong> can be anything on the other end of the pipe:</li>
</ul>
</li>
<li>a file write stream (disk I/O delay),</li>
<li>a transform stream (CPU-bound operation),</li>
<li>or even network latency if you’re piping it to another request.</li>
</ul>
<p>To handle this gracefully, <strong>Busboy performs a clever trick</strong>. When the file stream’s internal buffer is full (<code>push()</code> returns <code>false</code>), Busboy <strong>temporarily saves</strong> its <code>_writecb</code> -  the callback passed by Node.js’ <code>Writable</code> stream to signal readiness for the next chunk - into the file stream’s <code>_readcb</code> property, and then sets <code>_writecb = null</code>.</p>
<p>Let’s see where this <code>_writecb</code> comes from in the first place:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln">1</span><span class="cl"><span class="nx">_write</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">enc</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">	<span class="k">this</span><span class="p">.</span><span class="nx">_writecb</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">	<span class="k">this</span><span class="p">.</span><span class="nx">_bparser</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_writecb</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">	  <span class="nx">callAndUnsetCb</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This <code>_write()</code> method belongs to the <code>Multipart</code> class, which extends Node’s <code>Writable</code> stream.<br>
It’s invoked automatically when the incoming <code>request’s</code> readable stream (for example, <code>req</code>) is piped into the <code>Busboy</code> instance like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln">1</span><span class="cl"><span class="nx">req</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">bb</span><span class="p">);</span>
</span></span></code></pre></div><p>Here, the <code>cb</code> parameter in <code>_write</code> method represents Node’s <strong>backpressure callback</strong>.<br>
Calling this callback tells Node.js,</p>
<blockquote>
<p>“I’m done processing this chunk, You can send me the next one.”</p></blockquote>
<p>By saving <code>cb</code> into <code>this._writecb</code>, Busboy is essentially saying:</p>
<blockquote>
<p>“Hold on, I’ll call this callback later, once I’m sure it’s safe to receive more data after parsing current chunk.”</p></blockquote>
<p>Now, when the file stream slows down (because its internal buffer is full), Busboy <strong>hands off</strong> this <code>_writecb</code> to the file stream by assigning it to <code>_readcb</code>.<br>
This is a crucial step: <em>it ties the writable side (Busboy) and the readable side (<code>FileStream</code>) together through deferred signalling.</em>
Later, when the consumer, Say, an <code>fs.WriteStream</code> writing to disk finishes processing some data and is ready for more, it triggers the <code>FileStream</code>’s <code>_read()</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln">1</span><span class="cl"><span class="nx">_read</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">	<span class="kr">const</span> <span class="nx">cb</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readcb</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">	  <span class="k">this</span><span class="p">.</span><span class="nx">_readcb</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">	  <span class="nx">cb</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This is where the “<strong>magic</strong>” happens.<br>
That previously saved callback (<code>cb</code>), which originally came from the <em>writable</em> side (<code>Busboy</code>), is now invoked by the readable side (<code>FileStream</code>).<br>
<strong>This signals back upstream that the consumer has caught up and Busboy can safely resume parsing and pushing more data.</strong></p>
<pre class="mermaid">
  sequenceDiagram
    participant Net as Network Socket (req)
    participant Busboy as Busboy Multipart (Writable)
    participant FS as FileStream (Readable)
    participant Disk as fs.WriteStream (Writable)

    Note over Net,Busboy: Normal data flow →
    Net-&gt;&gt;Busboy: chunk
    Busboy-&gt;&gt;FS: fileStream.push(chunk)
    FS-&gt;&gt;Disk: pipe(chunk)

    alt Buffer has space (push() returns true)
        Note over Busboy: ✅ FileStream buffer has room
        Busboy-&gt;&gt;Busboy: call this._writecb()&lt;br/&gt;(request next chunk)
    else Buffer full (push() returns false)
        Note over FS: ⚠️ FileStream buffer full
        Busboy-&gt;&gt;FS: FS._readcb = this._writecb&lt;br/&gt;this._writecb = null
        Note right of FS: Wait until downstream frees buffer
    end

    Note over Disk: Disk slowly writes data...
    Disk--&gt;&gt;FS: _read() called&lt;br/&gt;(ready for more)
    FS-&gt;&gt;Busboy: call _readcb()&lt;br/&gt;(resumes parsing)
    Busboy-&gt;&gt;FS: push(next chunk)
    FS-&gt;&gt;Disk: pipe(chunk)
</pre>
<p>In essence, this <strong>handoff of callbacks between <code>_writecb</code> and <code>_readcb</code></strong> is Busboy’s internal mechanism for <strong>propagating backpressure</strong>.<br>
It ensures that data flows smoothly from
The <code>req</code> (the network socket and <code>IncomingMessage</code> readable) →
into Busboy’s <code>Multipart</code> writable →
Through the <code>FileStream</code> readable →
And finally into the consumer <code>writable</code> (like the <code>filesystem</code>)
All without overwhelming any part of the chain.</p>
<h2 id="wrapping-up">Wrapping Up<a hidden class="anchor" aria-hidden="true" href="#wrapping-up">#</a></h2>
<p>This exploration of how Busboy parses multipart form data, manages <code>backpressure</code>, and coordinates between readable and writable streams gave me a much deeper understanding of Node.js stream internals.</p>
<p>As part of this deep dive, As I mentioned, I also proposed a small improvement to <code>Busboy</code> — <strong>adding support for a <code>totalFileSize</code> limit</strong> that stops processing once the total upload size crosses a configured threshold. You can check out the implementation for more details about the change here:<br>
🔗 <strong><a href="https://github.com/mscdex/busboy/pull/374/files">GitHub PR #374 – Add total file size limit support in Busboy</a></strong></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/blogs/tags/networking/">Networking</a></li>
      <li><a href="http://localhost:1313/blogs/tags/memory/">Memory</a></li>
      <li><a href="http://localhost:1313/blogs/tags/tcp/">TCP</a></li>
      <li><a href="http://localhost:1313/blogs/tags/os/">OS</a></li>
      <li><a href="http://localhost:1313/blogs/tags/nodejs/">NodeJS</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="http://localhost:1313/blogs/building-fault-tolerant-kv-storage-system---part-2/">
    <span class="title">Next »</span>
    <br>
    <span>Building Fault Tolerant KV Storage System - Part 2</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Multipart Form Uploads - Busboy and Node Streams on x"
            href="https://x.com/intent/tweet/?text=Multipart%20Form%20Uploads%20-%20Busboy%20and%20Node%20Streams&amp;url=http%3a%2f%2flocalhost%3a1313%2fblogs%2fmultipart-form-uploads---busboy-and-node-streams%2f&amp;hashtags=Networking%2cMemory%2cTCP%2cOS%2cNodeJS">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Multipart Form Uploads - Busboy and Node Streams on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fblogs%2fmultipart-form-uploads---busboy-and-node-streams%2f&amp;title=Multipart%20Form%20Uploads%20-%20Busboy%20and%20Node%20Streams&amp;summary=Multipart%20Form%20Uploads%20-%20Busboy%20and%20Node%20Streams&amp;source=http%3a%2f%2flocalhost%3a1313%2fblogs%2fmultipart-form-uploads---busboy-and-node-streams%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Multipart Form Uploads - Busboy and Node Streams on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fblogs%2fmultipart-form-uploads---busboy-and-node-streams%2f&title=Multipart%20Form%20Uploads%20-%20Busboy%20and%20Node%20Streams">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Multipart Form Uploads - Busboy and Node Streams on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fblogs%2fmultipart-form-uploads---busboy-and-node-streams%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Multipart Form Uploads - Busboy and Node Streams on whatsapp"
            href="https://api.whatsapp.com/send?text=Multipart%20Form%20Uploads%20-%20Busboy%20and%20Node%20Streams%20-%20http%3a%2f%2flocalhost%3a1313%2fblogs%2fmultipart-form-uploads---busboy-and-node-streams%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Multipart Form Uploads - Busboy and Node Streams on telegram"
            href="https://telegram.me/share/url?text=Multipart%20Form%20Uploads%20-%20Busboy%20and%20Node%20Streams&amp;url=http%3a%2f%2flocalhost%3a1313%2fblogs%2fmultipart-form-uploads---busboy-and-node-streams%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Multipart Form Uploads - Busboy and Node Streams on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Multipart%20Form%20Uploads%20-%20Busboy%20and%20Node%20Streams&u=http%3a%2f%2flocalhost%3a1313%2fblogs%2fmultipart-form-uploads---busboy-and-node-streams%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/blogs/">Learning Loop</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script type="module">
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs";

  
  function isDarkMode() {
    return (
      document.body.classList.contains("dark") ||
      localStorage.getItem("pref-theme") === "dark" ||
      (!localStorage.getItem("pref-theme") &&
        window.matchMedia("(prefers-color-scheme: dark)").matches)
    );
  }

  
  mermaid.initialize({
    startOnLoad: true,
    theme: isDarkMode() ? "dark" : "default",
    themeVariables: {
      dark: {
        primaryColor: "#ff6b6b",
        primaryTextColor: "#ffffff",
        primaryBorderColor: "#ff6b6b",
        lineColor: "#ffffff",
        secondaryColor: "#4ecdc4",
        tertiaryColor: "#45b7d1",
        background: "#1a1a1a",
        mainBkg: "#2d2d2d",
        secondBkg: "#3d3d3d",
        tertiaryBkg: "#4d4d4d",
      },
      default: {
        primaryColor: "#ff6b6b",
        primaryTextColor: "#000000",
        primaryBorderColor: "#ff6b6b",
        lineColor: "#000000",
        secondaryColor: "#4ecdc4",
        tertiaryColor: "#45b7d1",
      },
    },
  });

  
  const themeToggle = document.getElementById("theme-toggle");
  if (themeToggle) {
    themeToggle.addEventListener("click", () => {
      setTimeout(() => {
        mermaid.initialize({
          startOnLoad: false,
          theme: isDarkMode() ? "dark" : "default",
          themeVariables: {
            dark: {
              primaryColor: "#ff6b6b",
              primaryTextColor: "#ffffff",
              primaryBorderColor: "#ff6b6b",
              lineColor: "#ffffff",
              secondaryColor: "#4ecdc4",
              tertiaryColor: "#45b7d1",
              background: "#1a1a1a",
              mainBkg: "#2d2d2d",
              secondBkg: "#3d3d3d",
              tertiaryBkg: "#4d4d4d",
            },
            default: {
              primaryColor: "#ff6b6b",
              primaryTextColor: "#000000",
              primaryBorderColor: "#ff6b6b",
              lineColor: "#000000",
              secondaryColor: "#4ecdc4",
              tertiaryColor: "#45b7d1",
            },
          },
        });

        
        document.querySelectorAll(".mermaid").forEach((element) => {
          element.removeAttribute("data-processed");
          mermaid.init(undefined, element);
        });
      }, 100);
    });
  }
</script>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
